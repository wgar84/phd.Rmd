```{r options_ppca, include = FALSE}
opts_chunk $ set (fig.path = 'Figures/', dev = 'pdf')
```

```{r captions_ppca, include = FALSE}
captions $ fig.matrix_variation <- 'Representation of the steps used to characterize covariance matrix variation. In (a), the set of covariance matrices $\\mathbf{A}$, $\\mathbf{B}$ and $\\mathbf{C}$ in the neighbourhood of $\\mathbf{M}$ are projected into an Euclidean space and eigentensors are estimated (PM1 and PM2); in (b), these eigentensors are rotated to incorporate phylogenetic relatedness; in (c), covariance matrices corresponding to the upper and lower bounds of the confidence intervals for each axis are returned back to the original manifold. See text for more details. \\label{fig:matrix_variation}'

captions $ fig.ppca_eval <- 'Characterizing $\\mathbf{P}$-matrix variation using phylogenetic Principal Components. (a) Posterior distribution of eigenvalues obtained for pPCs; positive eigenvalues are associated with phylogenetic signal; negative eigenvalues are associated with convergence. (b) Distribution of mean SRD scores for each trait with respect to pPCs; each line represents a loess interpolation adjusted for each skull region, according to the legend. \\label{fig:ppca_eval}'

captions $ fig.phylo_full <- 'Phylogenetic decomposition of $\\mathbf{P}$-matrix variation. (a) Decomposition of matrix diversity over the phylogenetic hypothesis for Anthropoidea; the size of each circle indicates the percentage of diversity on each node, according to the legend. (b) Mean $\\mathbf{P}$-matrices of each species projected over the first and last two phylogenetic Principal Components (G1-2 and L1-2, respectively); cell colors represent projection values, according to the legend. \\label{fig:phylo_full}'

captions $ fig.srd_gl <- 'Covariance structure variation associated with the first and last two pPCs (Global 1-2 and Local 1-2, respectively), represented using posterior mean SRD scores. Dotted lines represent average SRD scores for each comparison. Traits are colored according to their assocation with each skull region, according to the legend. \\label{fig:srd_gl}'

captions $ fig.srd_shape <- 'Mean SRD scores for the first and last two phylogenetic PCs (Global 1-2 and Local 1-2, respectively) represented over the mean skull shape of diana guenons (*Cercopithecus diana*). \\label{fig:srd_shape}'

### if thesis

captions $ fig.rs_riem <- 'The relationship between Riemannian Distances and Random Skewers among pairs of $\\mathbf{P}$-matrices. Each observation is the posterior mean value for each statistic, estimated from $100$ posterior samples obtained for each OTU. Colors indicate the lower sample size in each pair, according to the legend. \\label{fig:rs_riem}'

captions $ fig.ss_local1 <- 'Relationship between sample sizes and the first local phylogenetic Principal Component. \\label{fig:ss_local1}'
    
```

# Introduction

In the present work, we build upon Haber's [-@haber_evolution_2015] contribution on the subject of comparing patterns of morphological integration under a phylogenetic framework, using Anthropoid Primates as a model organism, under the hypothesis that changes in covariance structure among Anthropoid species will follow a non-random pattern consistent with functional and developmental interactions.

# Methods

## Sample

Our sample consists of `r sum (Aux $ sample.size)` individuals, distributes across `r length (Aux $ sample.size)` species. 
These species are distributed throughout all major Anthropoid clades above the genus level, comprising all Platyrrhini genera and a substantial portion of Catarrhini genera.
We associate this database with a ultrametric phylogenetic hypothesis for Anthropoidea (\autoref{fig:phylo_model}), derived from @springer_macroevolutionary_2012.

Individuals in our sample are represented by 36 registered landmarks, using either a Polhemus 3Draw or a Microscribe 3DS for Platyrrhini and Catarrhini, respectively.
Twenty-two unique landmarks represent each individual (Figure \ref{fig:landmarks}), since fourteen of the 36 registered landmarks are bilaterally symmetrical. For more details on landmark registration, see @marroig_comparison_2001 and @oliveira_covariance_2009.
Databases from both previous studies were merged into a single database, retaining only those individuals in which all landmarks from both sides were present.
In the present work, we considered only covariance structure for the symmetrical component of variation; therefore, prior to any analysis, we controlled the effects of variation in assymmetry.
We followed the procedure outlined in @klingenberg_shape_2002 for bilateral structures by obtaning for each individual a symmetrical landmark configuration, averaging each actual shape with its reflection along the sagittal plane.

We used this database to obtain local shape variables [@marquez_measurement_2012], which represent infinitesimal volumetric expansions or retractions, calculated as the natural logarithm determinants of derivatives of the TPS function between each individual in our sample and a reference shape (in our case, the mean shape for the entire sample, estimated from a Generalized Procrustes algorithm).
Such derivatives were evaluated at the midpoints between pairs of landmarks represented in \autoref{fig:landmarks}, for a total of 38 local shape variables.

After obtaining these values, we estimated covariance $\mathbf{P}$-matrices for size (represented by the logarithm of Centroid Size) and local shape variables after removing fixed effects of little interest in the present context, such as sexual dimorphism, for example.
These effects were removed through a multivariate linear model adjusted for each species, according to \autoref{fig:phylo_model}.
We adjusted such models under a Bayesian framework, sampling $100$ residual covariance matrices from the posterior distribution of each model.
These distributions allow us to estimate uncertainty for any parameters derived from these matrices as credibility intervals; furthermore, since posterior distributions are conditional upon the prior distribution we used --- a uniform Wishart distribution --- every matrix sampled from these posterior distributions is also a realization of a Wishart distribution, therefore positive-definite regardless of sample size [@gelman_bayesian_2004]; in this framework, lower sample sizes imply in broader, less informative, credibility intervals.
For each posterior sample, we estimated geometric mean covariance matrices, since such mean respects the underlying structure of the Riemannian manifold in which positive-definite symmetric matrices lie [@moakher_differential_2005; @moakher_averaging_2006]; thus, these mean $\mathbf{P}$-matrices are also positive-definite, regardless of sample size.
For each species, we ran independent models, with 13000 iterations of MCMC sampling, discarding the 3000 initial iterations as a burnin period and further sampling one covariance matrix per 100 iterations to avoid autocorrelations induced by sequential sampling.

## Phylogenetic Decompostion of Matrix Diversity

In order to evaluate the distribution of covariance structure diversity during Anthropoid diversification, we estimated Riemannian distances among all pairs of mean $\mathbf{P}$-matrices, according to the definition given by @mitteroecker_ontogenetic_2009; for any pair of positive-definite covariance matrices $\mathbf{C}_i$ and $\mathbf{C}_j$ of size $p \times p$, the distance $d(\mathbf{C}_i, \mathbf{C}_j)$ is given by
\begin{equation}
d(\mathbf{C}_i, \mathbf{C}_j) = \sqrt{\sum_{k = 1}^p \ln^2 \lambda_k(\mathbf{C}_i\mathbf{C}_j^{-1})}
\label{eq:riemdist}
\end{equation}
where $\lambda_k(\cdot)$ refers to the $k$-th eigenvalue obtained from the spectral decomposition of a given matrix, in this case the product $\mathbf{C}_i\mathbf{C}_j^{-1}$.
This distance among pairs of $\mathbf{P}$-matrices is negatively correlated with Random Skewers comparisons (\autoref{fig:rs_riem}), a measurement of matrix similarity explored elsewhere [@cheverud_comparing_2007]; such correlation indicates that our exploration of Riemmanian distances among $\mathbf{P}$-matrices could be extended to other types of measurement of similarity or dissimilarity among these objects without hindrances. 

```{r rs_riem, echo = FALSE, fig.width = 8, fig.height = 8, fig.cap = captions $ fig.rs_riem}
if (thesis) ppca.extra $ rs.riem
```

Using these distances among $\mathbf{P}$-matrices, we estimate matrix diversity at each node of the phylogenetic tree of Anthropoidea using a measurement of the weighted distance among the distributions of matrix distances for the two descending edges, based on @pavoine_decomposition_2010.
For a fully resolved tree, diversity $w_i$ on node $i$ is given by
\begin{equation}
w_i = \frac{1}{2} \frac{n_\alpha n_\beta} {n_i n_T} D_{\Delta}^2(P_\alpha, P_\beta)
\label{eq:div}
\end{equation}
where $\alpha$ and $\beta$ represent the subsets of descendants from node $i$, and $n$ refers to the number of OTUs on each set ($n_i$ for the total descendants of node $i$; $n_T$ for the total number of OTUs considered; $n_\alpha$ and $n_\beta$ for the size of descending subsets).
$D_{\Delta}(P_\alpha, P_\beta)$ represents the actual distance between the two  distributions $P_\alpha$ and $P_\beta$ for descending nodes, as formulated by @rao_diversity_1982:
\begin{equation}
D_{\Delta} (P_\alpha, P_\beta) =
\sqrt{2 \bigg( 2 H_{\Delta} \bigg( \frac{P_\alpha + P_\beta}{2} \bigg) -
H_{\Delta}(P_\alpha) - H_{\Delta}(P_\beta) \bigg)}
\label{eq:distdist}
\end{equation}
where
\begin{equation}
H_{\Delta} (P) = \sum_{i,j \in P} \frac{d^2(\mathbf{C}_i, \mathbf{C}_j)}{2}
\label{eq:rao}
\end{equation}
represents Rao's quadratic entropy among Riemannian distances $d(\mathbf{C}_i, \mathbf{C}_j)$ as defined in \autoref{eq:riemdist}.

Following the framework estabilished by @pavoine_decomposition_2010, diversity $w_i$ can be normalized as $v_i = w_i / \sum_i w_i$ to represent the percentage of diversity with respect to the total diversity on the phylogenetic tree.
We test three different hypothesis regarding the distribution of $v_i$ values through Anthropoid diversification: (1) that $\mathbf{P}$-matrix diversity is concentrated in a single node; (2) that $\mathbf{P}$-matrix diversity is concentrated in a reduced number of nodes; (3) that $\mathbf{P}$-matrix diversity is skewed towards either the root or tips of the phylogeny, in a two-tailed test.
We test each hypothesis against the null hypothesis that the distribution of matrix diversity is randomly arranged over the phylogeny; such null hypothesis is represented by randomizing the association between terminal branches and covariance matrices, constructing $9999$ distributions of $v_i$ values that represent this scenario.
Each test is carried out using a different parameter derived from the distribution of $v_i$ values [described in detail by @pavoine_decomposition_2010], comparing the actual value obtained with a null distribution constructed using permutations.
The third hypothesis can be tested either by considering only the topology of the tree and by also considering branch lengths; both tests are similar to Blomberg's [-@blomberg_testing_2003] $K$ test, as they search for a phylogenetic signal in covariance structure diversity.

## Characterizing Covariance Matrix Variation

The tests described in the previous section allow us to pinpoint which nodes contribute mostly to divergence in covariance structure; however, these tests are not designed to properly describe the actual changes in $\mathbf{P}$-matrix structure that are responsible for such divergence. To actually represent such changes in a comprehensible manner, we combine a number of ordination techniques to reduce the dimensionality of the manifold that contains covariance matrices of size $p \times p$ (\autoref{fig:matrix_variation}).

For a Riemannian manifold, there exists at least one bijective function defined in the neighbourhood of a given covariance matrix $\mathbf{M}$ that maps the manifold to an Euclidean space --- a hyperplane with $p (p - 1) / 2$ dimensions also contained in $\mathbb{R}^{p \times p}$ --- and equips the manifold with a notion of inner product, thus allowing the construction of an orthonormal basis that can be used to describe variation in $\mathbf{P}$-matrix structure.
For a covariance matrix $\mathbf{X}$ in the neighbourhood of $\mathbf{M}$,
\begin{equation}
f(\mathbf{X}) = \log (\mathbf{M}^{- \frac{1}{2}} \mathbf{X} \mathbf{M}^{- \frac{1}{2}})
\label{eq:map}
\end{equation}
represents one possible function.
Here, the logarithm operator refers to matrix logarithm; for symmetric positive-definite matrices, this transformation is equivalent to applying the usual logarithm function to the eigenvalues of such matrix and reverting the spectral decomposition.
The function defined in \autoref{eq:map} also transforms the Riemannian distance among covariance matrices defined in \autoref{eq:riemdist} into Euclidean distances between transformed matrices [@moakher_differential_2005].

![`r captions $ fig.matrix_variation`](Figures/matrix_variation.png)

We defined the average matrix among all sampled $\mathbf{P}$-matrices as the location parameter $\mathbf{M}$ to map the entire set of posterior $\mathbf{P}$-matrices into an Euclidean space.
We then used these $\mathbf{P}$-matrices to produce axes of matrix variation using an eigentensor decomposition [@basser_spectral_2007; @hine_characterizing_2009] obtaining a set of eigentensors and eigenvalues that summarise matrix variation (\autoref{fig:matrix_variation}a).
As a consequence of using the mean covariance matrix for the entire sample over \autoref{eq:map}, the projections over eigentensors we obtained are naturally centered on $\mathbf{M}$. 

We used the projections of $\mathbf{P}$-matrices over these eigentensors as traits in a phylogenetic Principal Component Analysis [pPCA; @jombart_putting_2010], which produces a new set of axes of matrix variation that considers both trait dispersal and phylogenetic relationships among OTUs simultaneously. If $\mathbf{Z}$ represents a matrix with projections of $\mathbf{P}$-matrices over each eigentensor on its columns, phylogenetic PCs are the eigenvectors obtained from
\begin{equation}
\frac{1}{2n} \mathbf{Z}^t(\mathbf{W} + \mathbf{W}^t) \mathbf{Z}
\end{equation}
where $\mathbf{W}$ represents the matrix of phylogenetic distances between OTUs; here, the distance $w_{ij}$ between tips $i$ and $j$ is the sum of branch lengths from their last common ancestor to both tips.
Such analysis produces both positive and negative eigenvalues, which are respectively associated with variation close to the root of the tree ('Global') and variation close to the tips ('Local') in matrix structure (pPC1 and pPC2 in \autoref{fig:matrix_variation}b, respectively). @pavoine_decomposition_2010 argues that this contrast between Global and Local structures in phylogenetic PCs reflects phylogenetic signal and convergence in trait values, respectively.

For each pPC obtained in this manner, we obtained two covariance matrices by estimating the upper and lower limits of the 95\% confidence interval for each axis and mapping these values back to the manifold of symmetric positive-definite matrices (\autoref{fig:matrix_variation}c), defining the inverse operation associated with \autoref{eq:map} as
\begin{equation}
f^{-1}(\mathbf{X}) = \mathbf{M}^{\frac{1}{2}}\exp(\mathbf{X})\mathbf{M}^{\frac{1}{2}}
\label{eq:inv}
\end{equation}
where the exponential operator refers to matrix exponential. We used these covariance matrices to describe matrix variation associated with each axis comparing each pair of matrices with the Selection Response Decomposition tool [@marroig_selection_2011], in order to pinpoint which traits are associated with the divergence in covariance structure associated with each pPC.

In order to characterize such divergence in covariance structure with respect to the uncertainty in $\mathbf{P}$-matrix estimation, we carried out the analyses described in this section with both mean $\mathbf{P}$-matrices obtained from posterior samples, and with posterior samples themselves, obtaining $100$ sets of phylogenetic PCs and $100$ sets of paired covariance matrices for each axis, thus allowing us to estimate a posterior distribution of mean SRD scores for each trait in all pPCs. We use the phylogenetic PCA estimated over mean $\mathbf{P}$-matrices only to visualize the phylogenetic patterns described by each pPC, although these patterns do not change in the subset of posterior samples we examined.

We use the posterior distribution of mean SRD scores over traits and pPC to investigate whether these changes in trait-specific covariance structure along Anthropoid diversification are randomly distributed with respect to the skull regions delimited in \autoref{tab:dist} by comparing SRD scores estimated within each region for all pPCs.

### Software

We performed all analyses under R `r paste (version $ major, version $ minor, sep = '.')` [@r_core_team_r:_2015].
We fitted Bayesian linear models for estimating posterior $\mathbf{P}$-matrix samples using the *MCMCglmm* package [@hadfield_mcmc_2010].
Source code for the eigentensor decomposition can be found at <http://github.com/wgar84>.
The phylogenetic decomposition of diversity was provided by @pavoine_decomposition_2010 in their Supplemental Material, while pPCA is implemented in the *adephylo* package [@jombart_adephylo:_2010]; the SRD method is provided by the *evolqg* package (Melo *et al.*, in prep.).
In order to obtain symmetrical landmarks configurations, we used code provided by Annat Haber, available at <http://life.bio.sunysb.edu/morph/soft-R.html>.

# Results

\input{Tables/riem_decdiv} <!-- tab:decdiv -->

```{r phylo_full, echo = FALSE, fig.width = 10, fig.height = 12, fig.cap = captions $ fig.phylo_full, warning = FALSE}
Tree.Plots $ ppca
```

```{r ppca_eval, fig.width = 6, fig.height = 8, echo = FALSE, warning = FALSE, message = FALSE, fig.cap = captions $ fig.ppca_eval}
plot_grid(
  post.ppca $ plot.ppca.eval + xlab (''), 
  post.ppca $ plot.mean.hyp, 
  nrow = 2, labels = c('a', 'b'),
  label_size = 24, rel_heights = c(1, 1.25), align = 'v'
  )
```

```{r srd_gl, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = captions $ fig.srd_gl}
post.ppca $ plot.srd.gl12
```

```{r srd_shape, echo = FALSE, fig.width = 8.6, fig.height = 10.2, fig.cap = captions $ fig.srd_shape}
ppca.shape.comp
```

```{r ss_local1, echo = FALSE, fig.width = 8, fig.height = 8, fig.cap = captions $ fig.ss_local1}
if (thesis) ppca.extra $ ss.local1
```

# Discussion

