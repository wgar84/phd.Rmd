```{r options_ppca, include = FALSE}
opts_chunk $ set (fig.path = 'Figures/', dev = 'pdf')
```
```{r captions_ppca, include = FALSE}

captions $ fig.phylo_decdiv <- 'Decomposição de diversidade filogenética em respeito à estrutura de covariância utilizando distâncias Riemannianas. O tamanho do círculo indica o valor de diversidade associada cada nó, de acordo com a legenda. \\label{fig:phylo_decdiv}'

captions $ fig.ppca_eval <- 'Autovalores da decomposição espectral associada à Análise de Componentes Principais Filogenéticos. No painel superior, barras indicam o valor associado à cada autovalor; barras em cinza indicam autovalores cujos autovetores associados foram considerados nas análises subsequentes. No painel inferior, gráfico de dispersão entre a variância associada a cada autovetor e o índice de autocorrelação filogenética de Moran. \\label{fig:ppca_eval}'

captions $ fig.phylo_gl <- 'Projeções da variação de estrutura de covariância de cada espécie sobre os Componentes Principais Filogenéticos considerados, segundo a \\autoref{fig:ppca_eval}. Círculos azuis e vermelhos indicam valores positivos e negativos, respectivamente. A magnitude de cada projeção é indicada pelo tamanho do círculo, de acordo com a legenda. \\label{fig:phylo_gl}'

captions $ fig.srd_gl <- 'Comparações utilizando o método SRD dos limites associados ao intervalo de confiança de 95\\% cada Componente Principal Filogenético considerado, segundo a \\autoref{fig:ppca_eval}. \\label{fig:srd_gl}'

captions $ fig.srd_shape <- 'Comparações utilizando o método SRD representados sobre a forma craniana de um macaco rhesus (\\emph{Macaca mulatta}). Cores próximas ao vermelho indicam caracteres que divergem mais em relação à estrutura de covariância em cada comparação; cores próximas ao verde indicam pouca divergência. \\label{fig:srd_shape}'

```

# Introduction

In the present work, we build upon Haber's [-@haber_evolution_2015] contribution on the subject of comparing patterns of morphological integration under a phylogenetic framework, using Anthropoid Primates as a model organism, under the hypothesis that changes in covariance structure among Anthropoid species will follow a non-random pattern consistent with functional and developmental interactions.

# Methods

## Sample

Our sample consists of `r sum (Aux $ sample.size)` individuals, distributes across `r length (Aux $ sample.size)` species. 
These species are distributed throughout all major Anthropoid clades above the genus level, comprising all Platyrrhini genera and a substantial portion of Catarrhini genera.
We associate this database with a ultrametric phylogenetic hypothesis for Anthropoidea (\autoref{fig:phylo_model}), derived from @springer_macroevolutionary_2012.

Individuals in our sample are represented by 36 registered landmarks, using either a Polhemus 3Draw or a Microscribe 3DS for Platyrrhini and Catarrhini, respectively.
Twenty-two unique landmarks represent each individual (Figure \ref{fig:landmarks}), since fourteen of the 36 registered landmarks are bilaterally symmetrical. For more details on landmark registration, see @marroig_comparison_2001 and @oliveira_covariance_2009.
Databases from both previous studies were merged into a single database, retaining only those individuals in which all landmarks from both sides were present.
In the present work, we considered only covariance structure for the symmetrical component of variation; therefore, prior to any analysis, we controlled the effects of variation in assymmetry.
We followed the procedure outlined in @klingenberg_shape_2002 for bilateral structures by obtaning for each individual a symmetrical landmark configuration, averaging each actual shape with its reflection along the sagittal plane.

We used this database to obtain local shape variables [@marquez_measurement_2012], which represent infinitesimal volumetric expansions or retractions, calculated as the natural logarithm determinants of derivatives of the TPS function between each individual in our sample and a reference shape (in our case, the mean shape for the entire sample, estimated from a Generalized Procrustes algorithm).
Such derivatives were evaluated at the midpoints between pairs of landmarks represented in \autoref{fig:landmarks}, for a total of 38 local shape variables.

After obtaining these values, we estimated covariance $\mathbf{P}$-matrices for size (represented by the logarithm of Centroid Size) and local shape variables after removing fixed effects of little interest in the present context, such as sexual dimorphism, for example.
These effects were removed through a multivariate linear model adjusted for each species, according to \autoref{fig:phylo_model}.
We adjusted such models under a Bayesian framework, sampling $100$ residual covariance matrices from the posterior distribution of each model.
These distributions allow us to estimate uncertainty for any parameters derived from these matrices as credibility intervals; furthermore, since posterior distributions are conditional upon the prior distribution we used --- a uniform Wishart distribution --- every matrix sampled from these posterior distributions is also a realization of a Wishart distribution, therefore positive-definite regardless of sample size [@gelman_bayesian_2004]; in this framework, lower sample sizes imply in broader, less informative, credibility intervals.
For each posterior sample, we estimated geometric mean covariance matrices, since such mean respects the underlying structure of the Riemannian manifold in which positive-definite symmetric matrices lie [@moakher_differential_2005; @moakher_averaging_2006]; thus, these mean $\mathbf{P}$-matrices are also positive-definite, regardless of sample size.
For each species, we ran independent models, with 13000 iterations of MCMC sampling, discarding the 3000 initial iterations as a burnin period and further sampling one covariance matrix per 100 iterations to avoid autocorrelations induced by sequential sampling.

## Phylogenetic Matrix Diversity

In order to evaluate the distribution of covariance structure diversity during Anthropoid diversification, we estimated Riemannian distances among all pairs of mean $\mathbf{P}$-matrices, according to the definition given by @mitteroecker_ontogenetic_2009; for any pair of positive-definite covariance matrices $\mathbf{C}_i$ and $\mathbf{C}_j$ of size $p \times p$, the distance $d(\mathbf{C}_i, \mathbf{C}_j)$ is given by
\begin{equation}
d(\mathbf{C}_i, \mathbf{C}_j) = \sqrt{\sum_{k = 1}^p \ln^2 \lambda_k(\mathbf{C}_i\mathbf{C}_j^{-1})}
\label{eq:riemdist}
\end{equation}
where $\lambda_k(\cdot)$ refers to the $k$-th eigenvalue obtained from the spectral decomposition of a given matrix, in this case the product $\mathbf{C}_i\mathbf{C}_j^{-1}$.

Using these distances among $\mathbf{P}$-matrices, we estimate matrix diversity at each node of the phylogenetic tree of Anthropoidea using a measurement of the weighted distance among the distributions of matrix distances for the two descending edges, based on @pavoine_decomposition_2010.
For a fully resolved tree, diversity $w_i$ on node $i$ is given by
\begin{equation}
w_i = \frac{1}{2} \frac{n_\alpha n_\beta} {n_i n_T} D_{\Delta}^2(P_\alpha, P_\beta)
\label{eq:div}
\end{equation}
where $\alpha$ and $\beta$ represent the subsets of descendants from node $i$, and $n$ refers to the number of OTUs on each set ($n_i$ for the total descendants of node $i$; $n_T$ for the total number of OTUs considered; $n_\alpha$ and $n_\beta$ for the size of descending subsets).

$D_{\Delta}(P_\alpha, P_\beta)$ represents the actual distance between the two  distributions $P_\alpha$ and $P_\beta$ for descending nodes, as formulated by @rao_diversity_1982:
\begin{equation}
D_{\Delta} (P_\alpha, P_\beta) =
\sqrt{2 \bigg( 2 H_{\Delta} \bigg( \frac{P_\alpha + P_\beta}{2} \bigg) -
H_{\Delta}(P_\alpha) - H_{\Delta}(P_\beta) \bigg)}
\label{eq:distdist}
\end{equation}
where
\begin{equation}
H_{\Delta} (P) = \sum_{i,j \in P} \frac{d^2(\mathbf{C}_i, \mathbf{C}_j)}{2}
\label{eq:rao}
\end{equation}
represents Rao's quadratic entropy among Riemannian distances $d(\mathbf{C}_i, \mathbf{C}_j)$ as defined in \autoref{eq:riemdist}.

Following the framework estabilished by @pavoine_decomposition_2010, diversity $w_i$ can be normalized as $v_i = w_i / \sum_i w_i$ to represent the percentage of diversity with respect to the total diversity on the phylogenetic tree.
We test three different hypothesis regarding the distribution of $v_i$ values through Anthropoid diversification: (1) that matrix diversity is concentrated in a single node; (2) that $\mathbf{P}$-matrix diversity is concentrated in a reduced number of nodes; (3) that $\mathbf{P}$-matrix diversity is skewed towards either the root or tips of the phylogeny, in a two-tailed test.
We test each hypothesis against the null hypothesis that the distribution of matrix diversity is randomly arranged over the phylogeny; such null hypothesis is represented by randomizing the association between terminal branches and covariance matrices, constructing $10000$ distributions of $v_i$ values that represent this scenario.
Each test is carried out using a different parameter derived from the distribution of $v_i$ values, comparing the actual value obtained with a null distribution constructed using permutations.
The third hypothesis can be tested either by considering only the topology of the tree and by also considering branch lengths, and both tests are similar to Blomberg's [-@blomberg_testing_2003] $K$ test, as they search for a phylogenetic signal in covariance structure diversity.

<!-- pensar melhor nisso -->

## Characterizing Covariance Matrix Variation

The tests regarding matrix diversity along the phylogeny described in the previous section allow us to pinpoint which nodes contribute mostly to divergence in covariance structure; however, these tests are not designed to properly describe the actual changes in $P$-matrix structure that are responsible for such divergence.
We first choose a bijective function between the Riemannian manifold of covariance matrices of size $p \times p$ [$Sym^{+}(p, \mathbb{R})$ in @mitteroecker_ontogenetic_2009] and an Euclidean space of equivalent dimensionality (in this case, $\mathbb{R}^{p (p - 1)/ 2}$); if $\mathbf{C}_i \in Sym^{+}(p, \mathbb{R})$,
\begin{equation}
\mathbf{C}'_i = \log (\mathbf{M}^{- \frac{1}{2}} \mathbf{C}_i \mathbf{M}^{- \frac{1}{2}})
\label{eq:map}
\end{equation}
represents one possible bijective map, as $\mathbf{C}'_i \in \mathbb{R}^{p (p - 1)/ 2}$; $\mathbf{M}$ refers to the location parameter of this particular map. 

Em seguida, usamos projeções da matriz sobre os autotensores como caracteres em uma Análise de Componentes Principais filogenética [pPCA; @jombart_putting_2010], que decompõe estes caracteres em eixos que estão associados a disparidade global (perto de raiz) e local (perto do topo). Para cada eixo recuperado pela pPCA, reconstruímos duas matrizes de covariância, associadas aos limites inferior e superior do intervalo de confiança de 95\%. Nós sujeitamos cada um destes pares de matrizes à decomposição de resposta a seleção [SRD; @marroig_selection_2011], a fim de avaliar quais caracteres são associados à divergência na estrutura de covariância para cada nível hierárquico na filogenia, definidos pelos componentes principais filogenéticos.

# Results

Os testes de disparidade de estrutura de covariância ao longo da filogenia (\autoref{tab:riem_decdiv}) indicam, em conjunto, que a maior parte das diferenças em estrutura de covariância se localizam na base da filogenia, associada à divergência entre Platyrrhini e Catarrhini (\autoref{fig:phylo_decdiv}).

\input{Tables/riem_decdiv} <!-- tab:decdiv -->

```{r phylo_decdiv, echo = FALSE, fig.width = 7, fig.height = 7, fig.cap = captions $ fig.phylo_decdiv}
layout(matrix (c(1, 1, 1, 1, 1, 1, 1, 1, 2), nrow = 3, byrow = T))

par(mar = c(0, 0, 0, 0))
plot (Tree [[1]], type = 'fan', cex = 0.5, show.tip.label = FALSE,
      x.lim = c(-.6, .6), y.lim = c(-.48, .48))
nodelabels(cex = ppca.Data $ div.nodes.def * 100 / sum (ppca.Data $ div.nodes.def),
           frame = 'none', pch = 20)
Plot.taxa()

par(mar = c(0, 0, 2, 0), bty = 'n', xaxt = 'n', yaxt = 'n')
plot (c(-2, -1, 0, 1, 2), c(0, 0, 0, 0, 0), pch = 20,
      cex =  c(0.25, 0.5, 0.75, 1, 1.25) * 100 / sum (ppca.Data $ div.nodes.def), xlim = c(-2.5, 2.5))
text (x = c(-2, -1, 0, 1, 2), y = c(0, 0, 0, 0, 0) - 0.3,
      labels = paste (round (c(0.25, 0.5, 0.75, 1, 1.25) * 100 / sum (ppca.Data $ div.nodes.def)), '%', sep = ''))

```

A análise de componentes principais filogenéticos recupera um conjunto de autovalores positivos que, em geral, possuem magnitudes maiores do que suas contrapartes negativas (\autoref{fig:ppca_eval}). Isso indica que a maior parte da divergência de estrutura de covariância está localizada na divergência entre linhagens mais próximas da raiz da filogenia do que entre espécies irmãs, em concordância com a análise de disparidade.

```{r ppca_eval, fig.width = 5, fig.height = 7, echo = FALSE, warning = FALSE, message = FALSE, fig.cap = captions $ fig.ppca_eval}
ppca.Plots $ eval
```

Podemos observar que as projeções das espécies sobre cada componente principal filogenético considerado (\autoref{fig:phylo_gl}) indicam que o primeiro componente global está associado a um contraste entre Platyrrhini e Catarrhini, enquanto o segundo componente global se associa a contrastes dentre estas duas linhagens. Os componentes locais representam diferenças locais entre espécies-irmãs, como por exemplo entre as duas espécies de *Gorilla* e entre as espécies do gênero *Callithrix*.

```{r phylo_gl, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = captions $ fig.phylo_gl}

values.axis <- etd.def.ppca $ li [, c(1, 2, 4, 3)]

par (mfrow = c(2, 2), mar = c(1.5, 1.5, 1.5, 1.5))
for (i in 1:4)
  {

    plot.phylo(Tree [[1]], type = 'fan',
               main = unique (ppca.Data $ SRD.limits.df $ axis) [i],
               use.edge.length = TRUE, show.tip.label = FALSE,
               y.lim = c(- 0.5, 0.5), x.lim = c(- 0.5, 0.5))

    tiplabels(tip = 1:109,
              pch = 20,
              col = ifelse (values.axis [, i] < 0,
                rgb (0,0,1,0.5), rgb (1,0,0,0.5)), bg = NULL,
              cex = abs (values.axis[, i]))

    Plot.taxa(ifelse(i == 1, T, F))

  }

legend('bottomright', bty = 'n', pt.cex = 1:4, yjust = 0.5,
       legend = 1:4, cex = 0.6, y.intersp = 2, x.intersp = 2, 
       pch = 20, col = rgb (0,0,0,0.5))
```

Ao reconstruírmos a variação em termos de estrutura de covariância associada a estes componentes, a análise de SRD (Figuras \ref{fig:srd_gl} e \ref{fig:srd_shape}) sobre os limites do intervalo de confiança de 95\% de cada eixo indicam que em cada nível de divergência (associados aos contrastes entre linhagens na pPCA) as maiores diferenças em termos de estrutura de covariância se localizam dentre os caracteres da Órbita e da Base, conforme indicado pelas médias menores e desvios-padrão maiores na \autoref{fig:srd_gl}. Além dos caracteres nestas duas regiões, a estrutura de covariância associada ao tamanho do centróide também se mostrou divergente nos diferentes níveis delimitados pela pPCA.

```{r srd_gl, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = captions $ fig.srd_gl}
ppca.Plots $ post.srd.def
```

```{r srd_shape, echo = FALSE, fig.width = 8.6, fig.height = 10.2, fig.cap = captions $ fig.srd_shape}
ppca.Data $ post.arc %>%
  filter(Type == 'Local Shape Variables') %>%
  mutate('trait2' = factor (as.character(trait), levels = rownames (Aux $ def.hyp))) %>%
  group_by(axis, trait2) %>%
  summarise_each(funs(mean), value) %$%
  {
    for (i in 1:4)
      {
        current.value <- value [axis == levels (axis) [i]]
        PlotShapeDeformation(Reference [, , 'Macaca_mulatta'], Aux $ tessel.38,
                             ColorsContinuous = c(current.value [-1], current.value [-1]),
                             palette = colorRamp(c('red', 'green'), space = 'Lab'),
                             view = c(1, 2), bty = 'n', add = ifelse (i == 1, F, T),
                             center = c(-0.5, -i, 0),
                             ylim = c(-4.2, -0.8), xlim = c(-1.3, 1), scale = 1.5,
                             graph.par = list ('mar' = c(0, 0, 0, 0)))
        PlotShapeDeformation(Reference [, , 'Macaca_mulatta'], Aux $ tessel.38,
                             ColorsContinuous = c(current.value [-1], current.value [-1]),
                             palette = colorRamp(c('red', 'green'), space = 'Lab'),
                             view = c(1, 3), bty = 'n', add = T, center = c(0.5, 0, -i),
                             scale = 1.5)
        if (i < 4)
          abline(h = - i - 0.5)
      }
  }
text(y = -(1:4), x = rep (-1.2, 4),
     labels = c('Global 1', 'Global 2', 'Local 1', 'Local 2'))
```

# Discussion

Os resultados obtidos aqui indicam que a magnitude de disparidade em estrutura de covariância para variáveis de forma e tamanho do centróide está associada à distância filogenética (\autoref{tab:riem_decdiv}, \autoref{fig:phylo_decdiv}); entretanto, aqueles caracteres que representam estas divergências em estrutura de covariância são os mesmo independente da escala taxonômica considerada.

O Basicrânio é composto de um mosaico de células originadas de tecidos distintos, que ossificam muito cedo durante o desenvolvimento [@lieberman_spatial_2008; @lieberman_epigenetic_2011]; ademais, os ossos do basicrânio se associam topologicamente a grande maioria dos ossos do crânio [@esteve-altava_beyond_2014], sofrendo, ao longo do desenvolvimento, influência do crescimento e diferenciação dos ossos circundantes. Em contrapartida, a estrutura de covariância associada ao tamanho do centróide reflete principalmente o crescimento e diferenciação pós-natal [@porto_size_2013].

Assim sendo, mudanças na estrutura de covariância estão associadas a eventos particulares do desenvolvimento, mostrando um padrão consistente ao longo da diversificação dos primatas antropóides, refletindo o efeito de interações funcionais e ontogenéticas.

